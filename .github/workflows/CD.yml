name: CD Pipeline for FastAPI Backend

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./E1_arquitectura_de_software

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1  # Changed to us-east-1 for ECR Public

      - name: Login to Amazon ECR Public
        id: login-ecr-public
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: public
          mask-password: "true"

      # Contenedor API FastAPI
      - name: Build, tag, and push Docker image for API
        env:
          REGISTRY: ${{ steps.login-ecr-public.outputs.registry }}
          REGISTRY_ALIAS: e8f5b0r5
          REPOSITORY: stocks-api
          IMAGE_TAG: latest
        run: |
          cd api
          docker build -t $REGISTRY/$REGISTRY_ALIAS/$REPOSITORY:$IMAGE_TAG .
          docker push $REGISTRY/$REGISTRY_ALIAS/$REPOSITORY:$IMAGE_TAG

      # Contenedor Broker Updates
      - name: Build, tag, and push Docker image for broker-updates
        env:
          REGISTRY: ${{ steps.login-ecr-public.outputs.registry }}
          REGISTRY_ALIAS: e8f5b0r5
          REPOSITORY: broker-updates
          IMAGE_TAG: latest
        run: |
          cd broker_updates
          docker build -t $REGISTRY/$REGISTRY_ALIAS/$REPOSITORY:$IMAGE_TAG .
          docker push $REGISTRY/$REGISTRY_ALIAS/$REPOSITORY:$IMAGE_TAG

      # Contenedor Broker Requests
      - name: Build, tag, and push Docker image for broker-requests
        env:
          REGISTRY: ${{ steps.login-ecr-public.outputs.registry }}
          REGISTRY_ALIAS: e8f5b0r5
          REPOSITORY: broker-requests
          IMAGE_TAG: latest
        run: |
          cd broker_requests
          docker build -t $REGISTRY/$REGISTRY_ALIAS/$REPOSITORY:$IMAGE_TAG .
          docker push $REGISTRY/$REGISTRY_ALIAS/$REPOSITORY:$IMAGE_TAG

  deploy-to-ec2:
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    defaults:
      run:
        working-directory: ./E1_arquitectura_de_software
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials for EC2 deployment
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2  # Keep us-east-2 for EC2/CodeDeploy

      - name: Create deployment package
        run: |
          zip -r deploy.zip docker-compose.production.yml appspec.yml scripts/

      - name: Upload to S3
        run: |
          aws s3 cp deploy.zip s3://fastapi-stocks-deployment-us-east-2/deploy.zip

      - name: Create CodeDeploy Deployment
        id: create-deployment
        run: |
          deploymentId=$(aws deploy create-deployment \
            --application-name fastapi-stocks-app \
            --deployment-group-name fastapi-stocks-group \
            --region us-east-2 \
            --s3-location bucket=fastapi-stocks-deployment-us-east-2,key=deploy.zip,bundleType=zip \
            --description "FastAPI deployment from commit ${{ github.sha }}" | jq -r '.deploymentId')
          echo "DeploymentId=$deploymentId" >> $GITHUB_OUTPUT
    
      - name: Wait for deployment to finish
        run: |
          aws deploy wait deployment-successful \
            --deployment-id ${{ steps.create-deployment.outputs.deploymentId }} \
            --region us-east-2